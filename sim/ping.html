<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetSim | Ping Utility</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        @keyframes travelRight {
            from {
                left: 0%;
                opacity: 1;
            }

            to {
                left: 100%;
                opacity: 1;
            }
        }

        @keyframes travelLeft {
            from {
                left: 100%;
                opacity: 1;
            }

            to {
                left: 0%;
                opacity: 1;
            }
        }

        /* Custom scrollbar for terminal */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #334155;
            border-radius: 4px;
        }
    </style>
</head>

<body class="min-h-screen bg-slate-900 text-slate-200 selection:bg-cyan-500 selection:text-white pb-10">

    <!-- Header -->
    <header class="bg-slate-950 border-b border-slate-800 p-4 sticky top-0 z-10">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="bg-cyan-500/20 p-2 rounded-lg">
                    <i data-lucide="activity" class="w-6 h-6 text-cyan-400"></i>
                </div>
                <h1 class="text-xl font-bold bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent">
                    TheVoid: Ping Utility
                </h1>
            </div>
            <div class="text-xs text-slate-500 flex items-center gap-1">
                <i data-lucide="info" class="w-3 h-3"></i> Educational Simulator
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">

        <!-- Left Column: Controls & Config -->
        <div class="lg:col-span-1 space-y-6">

            <!-- Target Control -->
            <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-5 shadow-lg backdrop-blur-sm">
                <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <i data-lucide="settings" class="w-4 h-4"></i> Configuration
                </h2>

                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">Target Host</label>
                        <div class="flex gap-2">
                            <input type="text" id="target-host"
                                class="flex-1 bg-slate-900 border border-slate-700 rounded-md px-3 py-2 text-sm focus:outline-none focus:border-cyan-500 transition-colors disabled:opacity-50"
                                value="google.com" placeholder="google.com" />
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <button id="btn-toggle"
                            class="flex items-center justify-center gap-2 px-4 py-2 rounded-md font-semibold text-sm transition-all bg-cyan-500 text-slate-900 hover:bg-cyan-400 shadow-[0_0_15px_rgba(6,182,212,0.3)]">
                            <i data-lucide="play" class="w-4 h-4"></i> <span id="btn-toggle-text">Start Ping</span>
                        </button>
                        <button id="btn-clear"
                            class="flex items-center justify-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-md font-medium text-sm text-slate-300 transition-colors">
                            <i data-lucide="rotate-ccw" class="w-4 h-4"></i> Clear
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sliders -->
            <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-5 shadow-lg">
                <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4">Network Conditions</h2>

                <div class="space-y-6">

                    <!-- Latency Slider -->
                    <div>
                        <div class="flex justify-between text-xs mb-2">
                            <span class="text-slate-300">Base Latency</span>
                            <span class="text-cyan-400 font-mono"><span id="val-latency">45</span> ms</span>
                        </div>
                        <input type="range" min="1" max="1000" value="45" id="input-latency"
                            class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500" />
                    </div>

                    <!-- Jitter Slider -->
                    <div>
                        <div class="flex justify-between text-xs mb-2">
                            <span class="text-slate-300">Jitter (Variance)</span>
                            <span class="text-purple-400 font-mono">Â±<span id="val-jitter">10</span> ms</span>
                        </div>
                        <input type="range" min="0" max="200" value="10" id="input-jitter"
                            class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-purple-500" />
                        <p class="text-[10px] text-slate-500 mt-1">Randomness added to the ping time.</p>
                    </div>

                    <!-- Packet Loss Slider -->
                    <div>
                        <div class="flex justify-between text-xs mb-2">
                            <span class="text-slate-300">Packet Loss</span>
                            <span class="text-red-400 font-mono"><span id="val-loss">0</span>%</span>
                        </div>
                        <input type="range" min="0" max="100" value="0" id="input-loss"
                            class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-red-500" />
                    </div>

                </div>
            </div>

            <!-- Stats Panel -->
            <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-5 shadow-lg">
                <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4">Live Statistics</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-800">
                        <div class="text-slate-500 text-xs">Transmitted</div>
                        <div class="text-xl font-mono text-white" id="stat-transmitted">0</div>
                    </div>
                    <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-800">
                        <div class="text-slate-500 text-xs">Received</div>
                        <div class="text-xl font-mono text-emerald-400" id="stat-received">0</div>
                    </div>
                    <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-800">
                        <div class="text-slate-500 text-xs">Loss %</div>
                        <div class="text-xl font-mono text-slate-300" id="stat-loss-percent">0%</div>
                    </div>
                    <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-800">
                        <div class="text-slate-500 text-xs">Avg Latency</div>
                        <div class="text-xl font-mono text-cyan-400">
                            <span id="stat-avg-latency">0</span> <span class="text-sm text-slate-500">ms</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Visualization & Terminal -->
        <div class="lg:col-span-2 flex flex-col gap-6">

            <!-- Visualization Area -->
            <div
                class="bg-slate-950 border border-slate-800 rounded-xl p-6 relative overflow-hidden h-64 flex flex-col justify-between">
                <!-- Background Grid -->
                <div class="absolute inset-0 opacity-10" style="
                    background-image: linear-gradient(#334155 1px, transparent 1px), linear-gradient(90deg, #334155 1px, transparent 1px);
                    background-size: 20px 20px;
                "></div>

                <h3
                    class="relative z-10 text-xs font-semibold text-slate-500 uppercase tracking-widest flex items-center gap-2">
                    <i data-lucide="activity" class="w-3 h-3"></i> Network Topology
                </h3>

                <!-- Network Nodes -->
                <div class="relative z-10 flex items-center justify-between px-10 mt-8">

                    <!-- Client Node -->
                    <div class="flex flex-col items-center gap-3 z-20">
                        <div
                            class="w-16 h-16 bg-slate-800 rounded-2xl border-2 border-cyan-500/50 flex items-center justify-center shadow-[0_0_30px_rgba(6,182,212,0.2)]">
                            <i data-lucide="laptop" class="text-cyan-400 w-8 h-8"></i>
                        </div>
                        <span class="text-xs font-mono text-cyan-400">localhost</span>
                    </div>

                    <!-- The "Internet" / Connection Line -->
                    <div class="flex-1 h-1 bg-slate-800 mx-4 relative rounded-full" id="connection-line">
                        <!-- Router Icon in Middle -->
                        <div
                            class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-10 h-10 bg-slate-900 border border-slate-700 rounded-full flex items-center justify-center z-10">
                            <i data-lucide="globe" class="text-slate-500 w-5 h-5"></i>
                        </div>
                        <!-- Packets will be injected here -->
                    </div>

                    <!-- Server Node -->
                    <div class="flex flex-col items-center gap-3 z-20">
                        <div id="server-icon-container"
                            class="w-16 h-16 bg-slate-800 rounded-2xl border-2 border-slate-600 flex items-center justify-center shadow-lg transition-colors duration-300">
                            <i id="server-icon" data-lucide="server"
                                class="text-slate-500 w-8 h-8 transition-colors duration-300"></i>
                        </div>
                        <span class="text-xs font-mono text-slate-400" id="server-ip">0.0.0.0</span>
                    </div>

                </div>

                <!-- Connection Status Label -->
                <div class="text-center mt-4">
                    <span id="connection-status" class="text-xs px-2 py-1 rounded bg-slate-800 text-slate-500">
                        IDLE
                    </span>
                </div>
            </div>

            <!-- Terminal Output -->
            <div
                class="flex-1 bg-black rounded-xl border border-slate-800 p-4 font-mono text-sm overflow-hidden flex flex-col shadow-2xl h-[400px]">
                <div class="flex items-center gap-2 text-slate-500 border-b border-slate-800 pb-2 mb-2">
                    <i data-lucide="terminal" class="w-3 h-3"></i>
                    <span class="text-xs">bash - terminal</span>
                </div>

                <div id="terminal-content" class="flex-1 overflow-y-auto space-y-1 custom-scroll pr-2">
                    <div class="text-slate-500 w-full">user@netsim:~$ <span id="terminal-command-hint"></span></div>
                    <!-- Logs go here -->
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- Helper Functions ---
        const resolveHost = (host) => {
            let hash = 0;
            for (let i = 0; i < host.length; i++) {
                hash = host.charCodeAt(i) + ((hash << 5) - hash);
            }
            return `192.168.${Math.abs(hash % 255)}.${Math.abs((hash >> 8) % 255)}`;
        };

        const gaussianRandom = (mean, stdev) => {
            const u = 1 - Math.random();
            const v = Math.random();
            const z = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            return z * stdev + mean;
        };

        // --- State ---
        let state = {
            targetHost: 'google.com',
            baseLatency: 45,
            jitter: 10,
            packetLoss: 0,
            intervalTime: 1000,
            isRunning: false,
            resolvedIP: '',
            sequence: 1,
            stats: {
                transmitted: 0,
                received: 0,
                rtts: [],
                startTime: 0,
            },
            timerId: null
        };

        // --- DOM Elements ---
        const el = {
            targetHost: document.getElementById('target-host'),
            btnToggle: document.getElementById('btn-toggle'),
            btnToggleText: document.getElementById('btn-toggle-text'),
            btnToggleIcon: document.querySelector('#btn-toggle i'),
            btnClear: document.getElementById('btn-clear'),

            inputLatency: document.getElementById('input-latency'),
            valLatency: document.getElementById('val-latency'),

            inputJitter: document.getElementById('input-jitter'),
            valJitter: document.getElementById('val-jitter'),

            inputLoss: document.getElementById('input-loss'),
            valLoss: document.getElementById('val-loss'),

            statTransmitted: document.getElementById('stat-transmitted'),
            statReceived: document.getElementById('stat-received'),
            statLossPercent: document.getElementById('stat-loss-percent'),
            statAvgLatency: document.getElementById('stat-avg-latency'),

            serverIp: document.getElementById('server-ip'),
            serverIconContainer: document.getElementById('server-icon-container'),
            serverIcon: document.getElementById('server-icon'),

            connectionStatus: document.getElementById('connection-status'),
            connectionLine: document.getElementById('connection-line'),

            terminalContent: document.getElementById('terminal-content'),
            terminalCommandHint: document.getElementById('terminal-command-hint')
        };

        // --- UI Updates ---
        function updateStatsUI() {
            el.statTransmitted.textContent = state.stats.transmitted;
            el.statReceived.textContent = state.stats.received;

            const lossPercent = state.stats.transmitted > 0
                ? ((state.stats.transmitted - state.stats.received) / state.stats.transmitted) * 100
                : 0;

            el.statLossPercent.textContent = `${lossPercent.toFixed(0)}%`;
            if (lossPercent > 0) {
                el.statLossPercent.classList.remove('text-slate-300');
                el.statLossPercent.classList.add('text-red-400');
            } else {
                el.statLossPercent.classList.remove('text-red-400');
                el.statLossPercent.classList.add('text-slate-300');
            }

            const avg = state.stats.rtts.length > 0
                ? (state.stats.rtts.reduce((a, b) => a + b, 0) / state.stats.rtts.length).toFixed(0)
                : 0;
            el.statAvgLatency.textContent = avg;
        }

        function addLog(text, type = 'normal') {
            const div = document.createElement('div');
            div.textContent = text;
            if (type === 'timeout') div.className = 'text-red-400';
            else if (type === 'highlight') div.className = 'text-cyan-300 font-bold';
            else div.className = 'text-slate-300';

            el.terminalContent.appendChild(div);
            // Scroll to bottom
            el.terminalContent.scrollTop = el.terminalContent.scrollHeight;
        }

        function toggleServerActive(active) {
            if (active) {
                el.serverIconContainer.classList.remove('border-slate-600');
                el.serverIconContainer.classList.add('border-purple-500/50', 'shadow-[0_0_30px_rgba(168,85,247,0.2)]');
                el.serverIcon.classList.remove('text-slate-500');
                el.serverIcon.classList.add('text-purple-400');
            } else {
                el.serverIconContainer.classList.add('border-slate-600');
                el.serverIconContainer.classList.remove('border-purple-500/50', 'shadow-[0_0_30px_rgba(168,85,247,0.2)]');
                el.serverIcon.classList.add('text-slate-500');
                el.serverIcon.classList.remove('text-purple-400');
            }
        }

        function createPacket(type, duration) {
            const packet = document.createElement('div');
            // Packet styles
            packet.className = 'absolute top-1/2 -mt-1.5 w-3 h-3 bg-white rounded-full shadow-[0_0_10px_white] z-30 pointer-events-none';

            // Animation
            const animationName = type === 'request' ? 'travelRight' : 'travelLeft';
            packet.style.animation = `${animationName} ${duration}ms linear forwards`;

            el.connectionLine.appendChild(packet);

            // Create a cleanup timeout slightly longer than duration
            setTimeout(() => {
                if (packet.parentNode) packet.parentNode.removeChild(packet);
            }, duration + 50);
        }

        // --- Actions ---
        function startPing() {
            if (state.targetHost.trim() === '') return;

            state.isRunning = true;
            state.resolvedIP = resolveHost(state.targetHost);
            state.stats = { transmitted: 0, received: 0, rtts: [], startTime: Date.now() };
            state.sequence = 1;

            // UI Updates
            el.serverIp.textContent = state.resolvedIP;
            el.targetHost.disabled = true;

            // Button State
            el.btnToggle.classList.remove('bg-cyan-500', 'text-slate-900', 'hover:bg-cyan-400', 'shadow-[0_0_15px_rgba(6,182,212,0.3)]');
            el.btnToggle.classList.add('bg-red-500/10', 'text-red-400', 'border', 'border-red-500/50', 'hover:bg-red-500/20');
            el.btnToggleText.textContent = 'Stop';
            el.btnToggleIcon.setAttribute('data-lucide', 'square'); // Change icon to stop
            lucide.createIcons();

            el.connectionStatus.textContent = 'CONNECTION ACTIVE';
            el.connectionStatus.className = 'text-xs px-2 py-1 rounded bg-green-500/10 text-green-400 transition-colors';

            el.terminalCommandHint.textContent = `ping ${state.targetHost}`;

            updateStatsUI();
            addLog(`PING ${state.targetHost} (${state.resolvedIP}) 56(84) bytes of data.`);

            // Interval
            state.timerId = setInterval(pingLoop, state.intervalTime);
        }

        function stopPing() {
            state.isRunning = false;
            clearInterval(state.timerId);

            // Final Stats Calculation
            const totalTime = Date.now() - state.stats.startTime;
            const lossPercent = state.stats.transmitted > 0
                ? ((state.stats.transmitted - state.stats.received) / state.stats.transmitted) * 100
                : 0;

            addLog('', 'normal');
            addLog(`--- ${state.targetHost} ping statistics ---`, 'highlight');
            addLog(`${state.stats.transmitted} packets transmitted, ${state.stats.received} received, ${lossPercent.toFixed(1)}% packet loss, time ${totalTime}ms`, 'normal');

            if (state.stats.rtts.length > 0) {
                const min = Math.min(...state.stats.rtts);
                const max = Math.max(...state.stats.rtts);
                const avg = state.stats.rtts.reduce((a, b) => a + b, 0) / state.stats.rtts.length;
                const mdev = Math.sqrt(state.stats.rtts.map(x => Math.pow(x - avg, 2)).reduce((a, b) => a + b) / state.stats.rtts.length);

                addLog(`rtt min/avg/max/mdev = ${min.toFixed(3)}/${avg.toFixed(3)}/${max.toFixed(3)}/${mdev.toFixed(3)} ms`, 'normal');
            }
            addLog('', 'normal');

            // UI Reset
            el.targetHost.disabled = false;
            el.btnToggle.classList.remove('bg-red-500/10', 'text-red-400', 'border', 'border-red-500/50', 'hover:bg-red-500/20');
            el.btnToggle.classList.add('bg-cyan-500', 'text-slate-900', 'hover:bg-cyan-400', 'shadow-[0_0_15px_rgba(6,182,212,0.3)]');
            el.btnToggleText.textContent = 'Start Ping';
            el.btnToggleIcon.setAttribute('data-lucide', 'play');
            lucide.createIcons();

            el.connectionStatus.textContent = 'IDLE';
            el.connectionStatus.className = 'text-xs px-2 py-1 rounded bg-slate-800 text-slate-500 transition-colors';

            toggleServerActive(false);
        }

        function pingLoop() {
            // 1. Determine packet fate
            const isLost = Math.random() * 100 < state.packetLoss;

            // 2. Calculate latency
            let calculatedRTT = gaussianRandom(state.baseLatency, state.jitter);
            if (calculatedRTT < 1) calculatedRTT = 1;

            const oneWayTime = calculatedRTT / 2;

            // 3. Update Stats (Transmitted)
            state.stats.transmitted++;
            updateStatsUI();

            // 4. Visualize Request (Client -> Server)
            createPacket('request', oneWayTime);

            // 5. Handle Response
            if (isLost) {
                // Packet travels out but never returns
                setTimeout(() => {
                    // Logic for timeout could go here
                }, oneWayTime);
            } else {
                // Packet reaches server
                setTimeout(() => {
                    // Server flashes active
                    toggleServerActive(true);

                    // Create reply packet (Server -> Client)
                    createPacket('reply', oneWayTime);

                    // Packet Arrival at Client
                    setTimeout(() => {
                        toggleServerActive(false);

                        state.stats.received++;
                        state.stats.rtts.push(calculatedRTT);
                        updateStatsUI();

                        addLog(`64 bytes from ${state.resolvedIP}: icmp_seq=${state.sequence} ttl=54 time=${calculatedRTT.toFixed(1)} ms`);
                        state.sequence++;

                    }, oneWayTime);

                }, oneWayTime);
            }
        }

        // --- Event Listeners ---
        el.btnToggle.addEventListener('click', () => {
            if (state.isRunning) stopPing();
            else startPing();
        });

        el.btnClear.addEventListener('click', () => {
            el.terminalContent.innerHTML = '<div class="text-slate-500 w-full">user@netsim:~$ <span id="terminal-command-hint"></span></div>';
            // Re-capture hint element since we wiped it
            el.terminalCommandHint = document.getElementById('terminal-command-hint');
            if (state.isRunning) el.terminalCommandHint.textContent = `ping ${state.targetHost}`;
        });

        // Inputs
        el.targetHost.addEventListener('input', (e) => state.targetHost = e.target.value);

        el.inputLatency.addEventListener('input', (e) => {
            state.baseLatency = Number(e.target.value);
            el.valLatency.textContent = state.baseLatency;
        });

        el.inputJitter.addEventListener('input', (e) => {
            state.jitter = Number(e.target.value);
            el.valJitter.textContent = state.jitter;
        });

        el.inputLoss.addEventListener('input', (e) => {
            state.packetLoss = Number(e.target.value);
            el.valLoss.textContent = state.packetLoss;
        });

        // Create Icons
        lucide.createIcons();

    </script>
</body>

</html>