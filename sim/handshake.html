<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCP Handshake Lab</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        .terminal-scroll::-webkit-scrollbar { width: 8px; }
        .terminal-scroll::-webkit-scrollbar-track { background: #0f172a; }
        .terminal-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .terminal-scroll::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        @keyframes flow {
            0% { background-position: 0 0; }
            100% { background-position: 20px 0; }
        }
        .cable-flow {
            background-image: linear-gradient(90deg, transparent 50%, rgba(99, 102, 241, 0.3) 50%);
            background-size: 20px 100%;
            animation: flow 1s linear infinite;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 h-screen overflow-hidden flex flex-col selection:bg-indigo-500/30">

    <div id="root" class="h-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const IconPlay = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>;
        const IconSquare = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>;
        const IconRefresh = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="1 4 1 10 7 10"></polyline><polyline points="23 20 23 14 17 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path></svg>;
        const IconServer = () => <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect><rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect><line x1="6" y1="6" x2="6.01" y2="6"></line><line x1="6" y1="18" x2="6.01" y2="18"></line></svg>;
        const IconMonitor = () => <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>;
        const IconActivity = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>;
        const IconShield = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>;

        // --- Constants & Types ---
        const TRAVEL_TIME_MS = 2000;
        const TIMEOUT_MS = 3000;

        // --- Components ---

        const StateBadge = ({ state, isServer }) => {
            const getColor = (s) => {
                switch (s) {
                    case 'CLOSED': return 'bg-slate-800 text-slate-500 border-slate-700';
                    case 'LISTEN': return 'bg-sky-900/30 text-sky-400 border-sky-800/50';
                    case 'ESTABLISHED': return 'bg-emerald-900/30 text-emerald-400 border-emerald-800/50 shadow-[0_0_10px_rgba(16,185,129,0.2)]';
                    case 'TIME_WAIT': return 'bg-amber-900/30 text-amber-400 border-amber-800/50';
                    default: return 'bg-orange-900/30 text-orange-400 border-orange-800/50';
                }
            };
            return (
                <div className={`px-3 py-1.5 rounded-lg text-xs font-mono font-bold border ${getColor(state)} transition-all duration-300 flex items-center gap-2 shadow-sm`}>
                    <div className={`w-2 h-2 rounded-full ${state === 'ESTABLISHED' ? 'bg-emerald-500 animate-pulse shadow-[0_0_8px_rgba(16,185,129,0.8)]' : 'bg-current'}`}></div>
                    {state}
                </div>
            );
        };

        const Packet = ({ type, from, progress }) => {
            const leftPos = from === 'client' ? progress : 100 - progress;
            const getColors = (t) => {
                if (t.includes('SYN')) return 'bg-sky-500 border-sky-400 shadow-[0_4px_12px_rgba(14,165,233,0.4)]';
                if (t.includes('FIN')) return 'bg-rose-500 border-rose-400 shadow-[0_4px_12px_rgba(244,63,94,0.4)]';
                return 'bg-emerald-500 border-emerald-400 shadow-[0_4px_12px_rgba(16,185,129,0.4)]';
            };

            return (
                <div 
                    className="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 transition-none z-20 flex flex-col items-center"
                    style={{ left: `${leftPos}%` }}
                >
                    <div className={`px-3 py-1.5 rounded-lg text-xs font-bold text-white border-b-2 ${getColors(type)} flex items-center gap-1 transform -translate-y-full mb-2`}>
                        {type}
                    </div>
                    <div className="w-3 h-3 rounded-full bg-slate-200 border-[3px] border-slate-900 z-10"></div>
                </div>
            );
        };

        // --- Main App ---

        function TcpHandshakeLab() {
            const [clientState, setClientState] = useState('CLOSED');
            const [serverState, setServerState] = useState('LISTEN');
            const [packets, setPackets] = useState([]);
            const [logs, setLogs] = useState([]);
            
            const requestRef = useRef();
            const startTimeRef = useRef();
            const packetIdCounter = useRef(0);

            // Logging System
            const addLog = (source, message, type = 'info') => {
                const newLog = {
                    id: Date.now() + Math.random(),
                    timestamp: new Date().toLocaleTimeString('en-US', { hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit" }),
                    source,
                    message,
                    type
                };
                setLogs(prev => [newLog, ...prev]);
            };

            // Core Logic
            const sendPacket = (type, from) => {
                const id = packetIdCounter.current++;
                setPackets(prev => [...prev, {
                    id, type, from,
                    to: from === 'client' ? 'server' : 'client',
                    status: 'flying',
                    progress: 0
                }]);
                addLog(from === 'client' ? 'Client' : 'Server', `Sending [${type}] packet`, type.includes('FIN') ? 'warning' : 'info');
            };

            const handlePacketArrival = (packet) => {
                addLog(packet.to === 'client' ? 'Client' : 'Server', `Received [${packet.type}]`, 'success');

                if (packet.to === 'server') {
                    if (packet.type === 'SYN' && serverState === 'LISTEN') {
                        setServerState('SYN_RCVD');
                        setTimeout(() => sendPacket('SYN-ACK', 'server'), 500);
                    } else if (packet.type === 'ACK' && serverState === 'SYN_RCVD') {
                        setServerState('ESTABLISHED');
                        addLog('Network', 'Connection ESTABLISHED', 'success');
                    } else if (packet.type === 'FIN' && serverState === 'ESTABLISHED') {
                        setServerState('CLOSE_WAIT');
                        setTimeout(() => sendPacket('ACK', 'server'), 300);
                        setTimeout(() => {
                            if (serverState !== 'CLOSED') {
                                addLog('Server', 'Closing application socket...', 'info');
                                sendPacket('FIN', 'server');
                                setServerState('LAST_ACK');
                            }
                        }, 2500);
                    } else if (packet.type === 'ACK' && serverState === 'LAST_ACK') {
                        setServerState('CLOSED');
                        addLog('Server', 'Connection closed.', 'warning');
                    }
                }

                if (packet.to === 'client') {
                    if (packet.type === 'SYN-ACK' && clientState === 'SYN_SENT') {
                        setClientState('ESTABLISHED');
                        setTimeout(() => sendPacket('ACK', 'client'), 300);
                    } else if (packet.type === 'ACK' && clientState === 'FIN_WAIT_1') {
                        setClientState('FIN_WAIT_2');
                    } else if (packet.type === 'FIN' && (clientState === 'FIN_WAIT_2' || clientState === 'ESTABLISHED')) {
                        setClientState('TIME_WAIT');
                        setTimeout(() => sendPacket('ACK', 'client'), 300);
                        setTimeout(() => {
                            setClientState('CLOSED');
                            addLog('Client', 'TIME_WAIT timeout expired. Closed.', 'warning');
                        }, TIMEOUT_MS);
                    }
                }
            };

            // Animation Loop
            const animate = (time) => {
                if (!startTimeRef.current) startTimeRef.current = time;
                startTimeRef.current = time;

                const speed = 100 / TRAVEL_TIME_MS; 
                const step = speed * 16; 

                setPackets(prev => {
                    const next = prev.map(p => {
                        if (p.status === 'received') return p;
                        const newProgress = p.progress + step;
                        if (newProgress >= 100) return { ...p, progress: 100, status: 'received' };
                        return { ...p, progress: newProgress };
                    });

                    next.forEach(p => {
                        if (p.progress >= 100 && prev.find(old => old.id === p.id)?.status === 'flying') {
                            handlePacketArrival(p);
                        }
                    });

                    return next.filter(p => p.status === 'flying' || p.progress >= 100);
                });
                requestRef.current = requestAnimationFrame(animate);
            };

            useEffect(() => {
                requestRef.current = requestAnimationFrame(animate);
                return () => cancelAnimationFrame(requestRef.current);
            }, [clientState, serverState]);

            // Handlers
            const startConnection = () => {
                if (clientState !== 'CLOSED') return;
                setClientState('SYN_SENT');
                sendPacket('SYN', 'client');
            };

            const closeConnection = () => {
                if (clientState !== 'ESTABLISHED') return;
                setClientState('FIN_WAIT_1');
                sendPacket('FIN', 'client');
            };

            const reset = () => {
                setClientState('CLOSED');
                setServerState('LISTEN');
                setPackets([]);
                setLogs([]);
                addLog('System', 'Simulation Reset', 'info');
            };

            return (
                <div className="flex flex-col h-full">
                    {/* Header */}
                    <header className="bg-slate-900 border-b border-slate-800 px-8 py-4 flex items-center justify-between shrink-0 shadow-lg z-30">
                        <div className="flex items-center gap-3">
                            <div className="bg-indigo-600 p-2 rounded-lg text-white shadow-[0_0_15px_rgba(79,70,229,0.4)]">
                                <IconActivity />
                            </div>
                            <div>
                                <h1 className="text-xl font-bold text-slate-100 tracking-tight">Handshake Lab</h1>
                                <p className="text-xs text-slate-400 font-medium">TCP State Machine Visualizer</p>
                            </div>
                        </div>
                        <button 
                            onClick={reset}
                            className="flex items-center gap-2 text-slate-400 hover:text-indigo-400 hover:bg-slate-800 px-4 py-2 rounded-lg text-sm font-medium transition-colors border border-transparent hover:border-slate-700"
                        >
                            <IconRefresh /> Reset Simulation
                        </button>
                    </header>

                    {/* Main Stage */}
                    <main className="flex-1 bg-slate-950 relative flex flex-col items-center justify-center p-8 overflow-hidden">
                        
                        {/* Interactive Zone */}
                        <div className="w-full max-w-6xl flex items-center justify-between gap-8 mb-12 relative">
                            
                            {/* Client Node */}
                            <div className="w-72 bg-slate-900 rounded-2xl shadow-2xl border border-slate-800 p-1 relative group transition-transform hover:-translate-y-1 duration-500">
                                <div className="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-indigo-500 to-indigo-600 rounded-t-2xl opacity-80"></div>
                                <div className="p-6 flex flex-col items-center text-center">
                                    <div className="w-20 h-20 bg-slate-800/50 rounded-2xl flex items-center justify-center mb-4 text-indigo-400 border border-slate-700/50 shadow-inner">
                                        <IconMonitor />
                                    </div>
                                    <h2 className="text-lg font-bold text-slate-200">Client</h2>
                                    <p className="text-xs text-slate-500 font-mono mb-6">192.168.1.10:54321</p>
                                    <div className="w-full">
                                        <StateBadge state={clientState} />
                                    </div>
                                </div>
                            </div>

                            {/* Connection Layer */}
                            <div className="flex-1 relative flex flex-col items-center justify-center min-h-[200px]">
                                
                                {/* Cable Graphic */}
                                <div className="w-full h-2 bg-slate-800 rounded-full relative overflow-hidden mb-8 shadow-inner border border-slate-800/50">
                                    {clientState === 'ESTABLISHED' && (
                                        <div className="absolute inset-0 cable-flow w-full h-full"></div>
                                    )}
                                </div>

                                {/* Packet Animation Layer (Absolute) */}
                                <div className="absolute inset-x-0 top-1/2 -translate-y-[calc(50%+1rem)] h-20 pointer-events-none">
                                    {packets.map(p => p.status === 'flying' && (
                                        <Packet key={p.id} {...p} />
                                    ))}
                                </div>

                                {/* Action Buttons */}
                                <div className="flex gap-4 z-20">
                                    <button 
                                        onClick={startConnection}
                                        disabled={clientState !== 'CLOSED'}
                                        className={`flex items-center gap-2 px-6 py-3 rounded-xl font-bold shadow-lg transition-all transform active:scale-95 border
                                            ${clientState === 'CLOSED' 
                                                ? 'bg-indigo-600 text-white border-indigo-500 hover:bg-indigo-500 hover:shadow-[0_0_20px_rgba(79,70,229,0.3)] hover:-translate-y-0.5 cursor-pointer' 
                                                : 'bg-slate-800 text-slate-600 border-slate-700 cursor-not-allowed shadow-none'}`}
                                    >
                                        <IconPlay /> Initialize
                                    </button>

                                    <button 
                                        onClick={closeConnection}
                                        disabled={clientState !== 'ESTABLISHED'}
                                        className={`flex items-center gap-2 px-6 py-3 rounded-xl font-bold shadow-lg transition-all transform active:scale-95 border
                                            ${clientState === 'ESTABLISHED' 
                                                ? 'bg-rose-600 text-white border-rose-500 hover:bg-rose-500 hover:shadow-[0_0_20px_rgba(225,29,72,0.3)] hover:-translate-y-0.5 cursor-pointer' 
                                                : 'bg-slate-800 text-slate-600 border-slate-700 cursor-not-allowed shadow-none'}`}
                                    >
                                        <IconSquare /> Terminate
                                    </button>
                                </div>
                            </div>

                            {/* Server Node */}
                            <div className="w-72 bg-slate-900 rounded-2xl shadow-2xl border border-slate-800 p-1 relative group transition-transform hover:-translate-y-1 duration-500">
                                <div className="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-emerald-500 to-emerald-600 rounded-t-2xl opacity-80"></div>
                                <div className="p-6 flex flex-col items-center text-center">
                                    <div className="w-20 h-20 bg-slate-800/50 rounded-2xl flex items-center justify-center mb-4 text-emerald-400 border border-slate-700/50 shadow-inner">
                                        <IconServer />
                                    </div>
                                    <h2 className="text-lg font-bold text-slate-200">Server</h2>
                                    <p className="text-xs text-slate-500 font-mono mb-6">203.0.113.5:80</p>
                                    <div className="w-full">
                                        <StateBadge state={serverState} />
                                    </div>
                                    <div className="mt-4 flex items-center justify-center gap-1.5 text-[10px] font-semibold text-emerald-400 bg-emerald-950/30 px-3 py-1.5 rounded-full border border-emerald-900/50">
                                        <IconShield /> FIREWALL ACTIVE
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Status Message */}
                        <div className="max-w-2xl text-center">
                            <p className="text-slate-400 text-sm leading-relaxed bg-slate-900/80 backdrop-blur px-8 py-3 rounded-full border border-slate-800 inline-block shadow-lg">
                                {clientState === 'CLOSED' && serverState === 'LISTEN' && "System Ready. Server is listening. Initiate connection to begin 3-Way Handshake."}
                                {clientState === 'SYN_SENT' && "Client sent SYN. Waiting for Server SYN-ACK response."}
                                {serverState === 'SYN_RCVD' && "Server acknowledged SYN. Establishing synchronization."}
                                {clientState === 'ESTABLISHED' && serverState === 'ESTABLISHED' && "Tunnel Established. Data stream is now active."}
                                {clientState.includes('FIN') && "Teardown initiated. Closing connection sequences."}
                                {clientState === 'TIME_WAIT' && "Client waiting (2MSL) for stray packets before full closure."}
                            </p>
                        </div>

                    </main>

                    {/* Console/Logs Footer */}
                    <footer className="h-64 bg-slate-900 border-t border-slate-800 flex flex-col shrink-0">
                        <div className="px-4 py-2 bg-slate-950 border-b border-slate-800 flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <span className="w-2.5 h-2.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.6)]"></span>
                                <span className="text-xs font-mono font-bold text-slate-400 uppercase tracking-widest">System Monitor</span>
                            </div>
                            <span className="text-[10px] text-slate-600 font-mono">/var/log/tcp_events.log</span>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 font-mono text-sm terminal-scroll flex flex-col-reverse bg-[#0b1120]">
                            {logs.length === 0 && <div className="text-slate-700 italic text-center mt-10">-- No events recorded --</div>}
                            {logs.map(log => (
                                <div key={log.id} className="mb-1.5 flex gap-3 text-slate-400 hover:text-slate-200 transition-colors">
                                    <span className="text-slate-600 shrink-0 select-none">[{log.timestamp}]</span>
                                    <span className={`w-16 shrink-0 font-bold ${log.source === 'Server' ? 'text-emerald-500' : log.source === 'Client' ? 'text-indigo-400' : 'text-slate-500'}`}>{log.source}</span>
                                    <span className={`
                                        ${log.type === 'success' ? 'text-emerald-400' : ''}
                                        ${log.type === 'warning' ? 'text-amber-400' : ''}
                                        ${log.type === 'error' ? 'text-rose-400' : ''}
                                    `}>
                                        {log.source === 'Client' || log.source === 'Server' ? '> ' : ''}{log.message}
                                    </span>
                                </div>
                            ))}
                        </div>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TcpHandshakeLab />);
    </script>
</body>
</html>